name: HuaweiCloud AKSK Signed Check
on:
  workflow_dispatch:

jobs:
  signed-check:
    runs-on: ubuntu-latest
    steps:
      # Step 1: Checkout repository (required for all workflows)
      - name: Checkout
        uses: actions/checkout@v4

      # Step 2: Inject Huawei Cloud credentials into environment variables
      # Make sure to configure these secrets in:
      # Repository → Settings → Secrets and variables → Actions
      # Required secrets:
      #   HW_AK          - Your Access Key ID
      #   HW_SK          - Your Secret Access Key
      #   HW_REGION      - Example: ap-southeast-2 (Sydney) or ap-southeast-3 (Singapore)
      #   HW_PROJECT_ID  - The Project ID that matches the region
      - name: Set Huawei Cloud credentials
        run: |
          echo "HW_AK=HPUA5GZJCTJM32UD9X1W" >> $GITHUB_ENV
          echo "HW_SK=zlzFxhnxtjEssQ6pKa9Ugsqh8Q5aJSUdqslwymJK" >> $GITHUB_ENV
          echo "HW_REGION=ap-southeast-2" >> $GITHUB_ENV
          echo "HW_PROJECT_ID=ee0f846e57794e34bcfdee41b77695e9" >> $GITHUB_ENV

      # Step 3: Use Huawei Cloud SDK to make a signed API call (read-only)
      # This workflow only verifies that AK/SK can successfully authenticate
      # It does not create, modify, or delete any resources
      - name: Verify AK/SK by signed SDK call (IAM list projects)
        run: |
          python -V
          pip install --upgrade pip
          pip install "huaweicloudsdkcore>=3.1.99" "huaweicloudsdkiam>=3.1.99"

          python - <<'PY'
          import os
          from huaweicloudsdkcore.auth.credentials import BasicCredentials
          from huaweicloudsdkcore.exceptions import exceptions
          from huaweicloudsdkcore.http.http_config import HttpConfig
          from huaweicloudsdkiam.v3 import IamClient, KeystoneListProjectsRequest

          ak = os.getenv("HW_AK")
          sk = os.getenv("HW_SK")
          region = os.getenv("HW_REGION")
          project_id = os.getenv("HW_PROJECT_ID")

          assert ak and sk and region and project_id, "❌ Missing HW_AK/HW_SK/HW_REGION/HW_PROJECT_ID"

          endpoint = f"https://iam.{region}.myhuaweicloud.com"

          # Build IAM client using AK/SK (the SDK automatically signs the request)
          http_config = HttpConfig.get_default_config()
          http_config.ignore_ssl_verification = False
          cred = BasicCredentials(ak, sk, project_id)
          client = IamClient.new_builder() \
              .with_http_config(http_config) \
              .with_credentials(cred) \
              .with_endpoint(endpoint) \
              .build()

          try:
