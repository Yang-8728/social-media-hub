name: HuaweiCloud AKSK Read Proof (no external action)
on:
  workflow_dispatch:  # 手动点运行

jobs:
  read-proof:
    runs-on: ubuntu-latest
    steps:
      # 1) 拉取代码
      - name: Checkout
        uses: actions/checkout@v4

      # 2) 手动注入华为云凭证到环境变量（等价于登录）
      #    需要在仓库 Settings → Secrets and variables → Actions 配置：
      #    HW_AK / HW_SK / HW_PROJECT_ID / HW_REGION / HW_OBS_ENDPOINT
      - name: Set Huawei Cloud creds
        run: |
          echo "HUAWEICLOUD_SDK_AK=HPUA5GZJCTJM32UD9X1W" >> $GITHUB_ENV
          echo "HUAWEICLOUD_SDK_SK=zlzFxhnxtjEssQ6pKa9Ugsqh8Q5aJSUdqslwymJK" >> $GITHUB_ENV
          echo "HUAWEICLOUD_SDK_PROJECT_ID=ee0f846e57794e34bcfdee41b77695e9">> $GITHUB_ENV
          echo "HUAWEICLOUD_SDK_REGION=ap-southeast-2" >> $GITHUB_ENV

# 调用 IAM 公共 API 验证是否能拿到项目信息（只读、零改动）
      - name: Verify AK/SK works
        run: |
          pip install requests
          python - <<'PY'
          import os, requests, json, base64, hmac, hashlib, datetime

          ak = os.getenv("HUAWEICLOUD_SDK_AK")
          sk = os.getenv("HUAWEICLOUD_SDK_SK")
          region = os.getenv("HUAWEICLOUD_SDK_REGION")
          project_id = os.getenv("HUAWEICLOUD_SDK_PROJECT_ID")
          assert ak and sk and region, "❌ 缺少环境变量 AK/SK/REGION"

          url = f"https://iam.{region}.myhuaweicloud.com/v3/projects"
          print(f"Test URL: {url}")

          # 用 requests 调用 IAM 的公开列表项目 API
          resp = requests.get(url, timeout=10)
          print("HTTP Status:", resp.status_code)
          if resp.status_code == 200:
              print("✅ AK/SK 测试环境可访问华为云 IAM 公共端点")
          else:
              print("⚠️ API 返回非200，可能网络正常但认证未用上（正常）")

          print("这只是验证 runner 能连接华为云；下一步可以尝试签名版 API 或 SDK 进一步验证。")
          PY
