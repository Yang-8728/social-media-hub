#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
æ·±å…¥åˆ†æåŒæ­¥æ‰«ææœºåˆ¶å¯¹é‡æ–°ä¸‹è½½çš„å½±å“
"""

import os
import json
import lzma
from pathlib import Path
import sys
sys.path.append('src')

def analyze_sync_scan_impact():
    """åˆ†æåŒæ­¥æ‰«æå¯¹æ¯”å¦‚ä½•å½±å“é‡æ–°ä¸‹è½½"""
    print("ğŸ” æ·±å…¥åˆ†æï¼šåŒæ­¥æ‰«æå¯¹æ¯”æœºåˆ¶")
    print("=" * 60)
    
    print("ğŸ“Š æ‰«æå¯¹æ¯”çš„è¯¦ç»†æµç¨‹:")
    print("-" * 40)
    
    print("1ï¸âƒ£ **å¿«é€ŸåŒæ­¥æ¨¡å¼** (é»˜è®¤):")
    print("   - æ‰«ææœ€è¿‘3å¤©çš„æ–‡ä»¶å¤¹")
    print("   - æå–æ¯ä¸ªjson.xzæ–‡ä»¶çš„shortcode")
    print("   - ä¸ä¸‹è½½æ—¥å¿—ä¸­çš„shortcodeè¿›è¡Œå¯¹æ¯”")
    print("   - å¦‚æœæ–‡ä»¶å­˜åœ¨ä½†æ—¥å¿—ä¸­æ— è®°å½• â†’ è¡¥å……æ—¥å¿—è®°å½•")
    print("   - å¦‚æœæ—¥å¿—ä¸­æœ‰è®°å½•ä½†æ–‡ä»¶ä¸å­˜åœ¨ â†’ **ä¸åšä»»ä½•æ“ä½œ**")
    
    print("\n2ï¸âƒ£ **å®Œæ•´åŒæ­¥æ¨¡å¼** (force_full=True):")
    print("   - æ‰«ææ‰€æœ‰ä¸‹è½½æ–‡ä»¶å¤¹")
    print("   - å…¨é¢å¯¹æ¯”æ‰€æœ‰shortcode")
    print("   - è¡¥å……æ‰€æœ‰ç¼ºå¤±çš„æ—¥å¿—è®°å½•")
    
    print("\n3ï¸âƒ£ **å…³é”®åˆ¤æ–­é€»è¾‘**:")
    print("   ```python")
    print("   def is_downloaded(shortcode):")
    print("       # æ­¥éª¤1: æ£€æŸ¥ä¸‹è½½æ—¥å¿—")
    print("       if shortcode in download_log:")
    print("           return True  # ğŸš« åœæ­¢æ£€æŸ¥ï¼Œä¸ä¼šä¸‹è½½")
    print("       ")
    print("       # æ­¥éª¤2: æ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿ")
    print("       if file_exists(shortcode):")
    print("           return True  # ğŸš« åœæ­¢æ£€æŸ¥ï¼Œä¸ä¼šä¸‹è½½")
    print("       ")
    print("       return False     # âœ… å…è®¸ä¸‹è½½")
    print("   ```")
    
    print("\nğŸ¯ **æ ¸å¿ƒé—®é¢˜è§£ç­”**:")
    print("=" * 50)
    
    print("â“ åˆ é™¤8-27æ–‡ä»¶å¤¹åï¼Œæ‰«æå¯¹æ¯”ä¼šå½±å“ä¸‹è½½å—ï¼Ÿ")
    print()
    
    print("**æƒ…å†µA: ä»…åˆ é™¤æ–‡ä»¶å¤¹ï¼Œä¿ç•™æ—¥å¿—è®°å½•**")
    print("   ğŸ“ æ—¥å¿—è®°å½•å­˜åœ¨ â†’ is_downloaded()è¿”å›True")
    print("   ğŸš« ç»“æœ: **ä¸ä¼šä¸‹è½½** (æ—¥å¿—æ£€æŸ¥ç›´æ¥é˜»æ­¢)")
    print("   ğŸ” æ‰«æå¯¹æ¯”: **æ— å½±å“** (æ—¥å¿—æ£€æŸ¥åœ¨å‰)")
    
    print("\n**æƒ…å†µB: åˆ é™¤æ–‡ä»¶å¤¹ + åˆ é™¤æ—¥å¿—è®°å½•**")
    print("   ğŸ“ æ—¥å¿—è®°å½•ä¸å­˜åœ¨ â†’ è¿›å…¥æ–‡ä»¶ç³»ç»Ÿæ£€æŸ¥")
    print("   ğŸ“ æ–‡ä»¶ä¸å­˜åœ¨ â†’ is_downloaded()è¿”å›False")
    print("   âœ… ç»“æœ: **ä¼šé‡æ–°ä¸‹è½½**")
    print("   ğŸ” æ‰«æå¯¹æ¯”: **æ— å½±å“** (æ²¡æœ‰æ–‡ä»¶å¯æ‰«æ)")
    
    print("\n**æƒ…å†µC: åˆ é™¤æ—¥å¿—è®°å½•ï¼Œä¿ç•™æ–‡ä»¶å¤¹**")
    print("   ğŸ“ æ—¥å¿—è®°å½•ä¸å­˜åœ¨ â†’ è¿›å…¥æ–‡ä»¶ç³»ç»Ÿæ£€æŸ¥")
    print("   ğŸ“ æ–‡ä»¶å­˜åœ¨ â†’ is_downloaded()è¿”å›True")
    print("   ğŸš« ç»“æœ: **ä¸ä¼šä¸‹è½½** (æ–‡ä»¶ç³»ç»Ÿæ£€æŸ¥é˜»æ­¢)")
    print("   ğŸ” æ‰«æå¯¹æ¯”: **ä¼šè¡¥å……æ—¥å¿—è®°å½•**")
    
    # æ¨¡æ‹Ÿæ‰«æå¯¹æ¯”çš„å…·ä½“è¡Œä¸º
    print("\nğŸ§ª **æ¨¡æ‹Ÿæ‰«æå¯¹æ¯”çš„å®é™…å½±å“**:")
    print("=" * 50)
    
    target_folder = Path("videos/downloads/ai_vanvan/2025-08-27")
    
    if target_folder.exists():
        json_files = list(target_folder.glob("*.json.xz"))
        print(f"ğŸ“‚ 8-27æ–‡ä»¶å¤¹: {len(json_files)} ä¸ªæ–‡ä»¶")
        
        # è¯»å–ç¬¬ä¸€ä¸ªæ–‡ä»¶ä½œä¸ºç¤ºä¾‹
        if json_files:
            try:
                with lzma.open(json_files[0], 'rb') as f:
                    data = json.loads(f.read().decode('utf-8'))
                    shortcode = data.get('node', {}).get('shortcode')
                    
                    print(f"\nğŸ“„ ç¤ºä¾‹æ–‡ä»¶: {json_files[0].name}")
                    print(f"ğŸ”‘ Shortcode: {shortcode}")
                    
                    print(f"\nğŸ”„ æ‰«æå¯¹æ¯”è¿‡ç¨‹:")
                    print(f"   1. æ‰«æå™¨æ‰¾åˆ°æ–‡ä»¶: {json_files[0].name}")
                    print(f"   2. æå–shortcode: {shortcode}")
                    print(f"   3. æŸ¥è¯¢ä¸‹è½½æ—¥å¿—: æ£€æŸ¥æ˜¯å¦æœ‰è®°å½•")
                    print(f"   4. å¦‚æœæœ‰è®°å½•: æ— æ“ä½œ")
                    print(f"   5. å¦‚æœæ— è®°å½•: æ·»åŠ  sync_added=True çš„è®°å½•")
                    
                    print(f"\nâš ï¸ **é‡è¦**: æ‰«æå¯¹æ¯”åªæ˜¯**è¡¥å……æ—¥å¿—è®°å½•**")
                    print(f"   å®ƒ**ä¸ä¼šå½±å“**ä¸‹è½½å†³ç­–ï¼")
                    print(f"   ä¸‹è½½å†³ç­–å®Œå…¨ç”± is_downloaded() æ§åˆ¶ã€‚")
                    
            except Exception as e:
                print(f"âŒ è¯»å–æ–‡ä»¶å¤±è´¥: {e}")
    
    else:
        print("âŒ 8-27æ–‡ä»¶å¤¹ä¸å­˜åœ¨")
    
    print(f"\nğŸ’¡ **æ€»ç»“å›ç­”ä½ çš„é—®é¢˜**:")
    print("=" * 40)
    print(f"\"åˆ é™¤ä»¥ååœ¨é‡æ–°æ‰§è¡Œä¸‹è½½ä¼šæœ‰ä¸€ä¸ªæ‰«æå’Œå¯¹æ¯”åŠ¨ä½œï¼Œå¯¹æ¯”shortcodeå’Œæ–‡ä»¶åï¼Œè¿™ä¸ªä¼šå½±å“ä¸‹è½½å—\"")
    print()
    print(f"**ç­”æ¡ˆ: âŒ ä¸ä¼šå½±å“ä¸‹è½½**")
    print()
    print(f"**åŸå› :**")
    print(f"1. ğŸ¯ æ‰«æå¯¹æ¯”çš„ç›®çš„æ˜¯**è¡¥å……ç¼ºå¤±çš„æ—¥å¿—è®°å½•**")
    print(f"2. ğŸš« ä¸‹è½½å†³ç­–ç”± is_downloaded() ç‹¬ç«‹æ§åˆ¶")
    print(f"3. ğŸ“ is_downloaded() ä¼˜å…ˆæ£€æŸ¥æ—¥å¿—è®°å½•")
    print(f"4. ğŸ” åªæœ‰æ—¥å¿—è®°å½•ä¸ºç©ºæ—¶æ‰æ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿ")
    print(f"5. âš¡ æ‰«æå¯¹æ¯”åœ¨ä¸‹è½½æ£€æŸ¥**ä¹‹å‰æˆ–ä¹‹å**è¿è¡Œéƒ½ä¸å½±å“ç»“æœ")
    
    print(f"\nğŸ¯ **å®é™…æµ‹è¯•åœºæ™¯**:")
    print(f"åˆ é™¤8-27æ–‡ä»¶å¤¹ â†’ æ‰€æœ‰æ—¥å¿—è®°å½•ä»å­˜åœ¨ â†’ is_downloaded()è¿”å›True â†’ è·³è¿‡ä¸‹è½½")
    print(f"æ‰«æå¯¹æ¯”å‘ç°æ–‡ä»¶ç¼ºå¤± â†’ æ— æ“ä½œ â†’ ä¸å½±å“ä¸‹è½½å†³ç­–")

def demonstrate_sync_behavior():
    """æ¼”ç¤ºåŒæ­¥è¡Œä¸º"""
    print(f"\nğŸ¬ **åŒæ­¥è¡Œä¸ºæ¼”ç¤º**:")
    print("=" * 40)
    
    # æ£€æŸ¥ç¼“å­˜æ–‡ä»¶
    cache_files = list(Path("videos/downloads").glob("**/.sync_cache"))
    
    print(f"ğŸ“‹ å½“å‰åŒæ­¥ç¼“å­˜:")
    if cache_files:
        for cache_file in cache_files:
            try:
                with open(cache_file, 'r') as f:
                    cache_data = json.load(f)
                    print(f"   ğŸ“ {cache_file.parent.name}: {cache_data.get('last_sync', 'Unknown')}")
            except:
                print(f"   ğŸ“ {cache_file.parent.name}: ç¼“å­˜æ–‡ä»¶æŸå")
    else:
        print(f"   âŒ æ²¡æœ‰æ‰¾åˆ°åŒæ­¥ç¼“å­˜æ–‡ä»¶")
    
    print(f"\nğŸ”§ åŒæ­¥ç¼“å­˜çš„ä½œç”¨:")
    print(f"   - 24å°æ—¶å†…è·³è¿‡é‡å¤æ‰«æ")
    print(f"   - æé«˜æ€§èƒ½ï¼Œé¿å…é‡å¤çš„æ–‡ä»¶ç³»ç»Ÿæ“ä½œ")
    print(f"   - ä¸å½±å“ä¸‹è½½é€»è¾‘ï¼Œåªå½±å“æ‰«æé¢‘ç‡")

def main():
    analyze_sync_scan_impact()
    demonstrate_sync_behavior()
    
    print(f"\n" + "="*60)
    print(f"ğŸ¯ **æœ€ç»ˆç»“è®º**:")
    print(f"æ‰«æå¯¹æ¯”æœºåˆ¶**ä¸ä¼šå½±å“**åˆ é™¤æ–‡ä»¶åçš„é‡æ–°ä¸‹è½½è¡Œä¸ºï¼")
    print(f"åˆ é™¤8-27æ–‡ä»¶å¤¹åï¼Œè¿™äº›è§†é¢‘**ä¸ä¼šé‡æ–°ä¸‹è½½**ï¼Œå› ä¸ºæ—¥å¿—è®°å½•ä»ç„¶å­˜åœ¨ã€‚")
    print(f"è¦é‡æ–°ä¸‹è½½ï¼Œå¿…é¡»åŒæ—¶åˆ é™¤æ–‡ä»¶å’Œæ—¥å¿—è®°å½•ã€‚")

if __name__ == "__main__":
    main()
